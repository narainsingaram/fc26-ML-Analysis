<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FC26 Analytics Lab</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
  <header>
    <h1>
      <span class="text-gradient">FC26</span> Analytics Lab
    </h1>
    <a href="/" class="btn secondary" style="text-decoration: none; font-size: 0.875rem;">← Back to Engine</a>
  </header>

  <main>
    <!-- Top KPI Cards -->
    <div class="grid">
      <div class="col-span-3 card" style="display:flex; flex-direction:column; align-items:center;">
        <div class="tiny muted" style="margin-bottom:0.5rem; text-transform:uppercase;">RMSE</div>
        <div class="value" id="rmse" style="font-size: 2rem; font-weight: 800; color: var(--accent-cyan);">—</div>
      </div>
      <div class="col-span-3 card" style="display:flex; flex-direction:column; align-items:center;">
        <div class="tiny muted" style="margin-bottom:0.5rem; text-transform:uppercase;">MAE</div>
        <div class="value" id="mae" style="font-size: 2rem; font-weight: 800; color: var(--accent-violet);">—</div>
      </div>
      <div class="col-span-3 card" style="display:flex; flex-direction:column; align-items:center;">
        <div class="tiny muted" style="margin-bottom:0.5rem; text-transform:uppercase;">R² Score</div>
        <div class="value" id="r2" style="font-size: 2rem; font-weight: 800; color: var(--accent-emerald);">—</div>
      </div>
      <div class="col-span-3 card" style="display:flex; flex-direction:column; align-items:center;">
        <div class="tiny muted" style="margin-bottom:0.5rem; text-transform:uppercase;">Records</div>
        <div class="value" id="count" style="font-size: 2rem; font-weight: 800; color: var(--text-primary);">—</div>
      </div>
    </div>

    <!-- Methodology & Insights -->
    <div class="grid">
      <div class="col-span-8 card">
        <h3 style="margin-bottom: 1rem;">Methodology Reference</h3>
        <ul class="muted small" style="line-height: 1.6; padding-left: 1.2rem;">
          <li><strong style="color:var(--text-primary)">RMSE</strong>: Punishes large errors more heavily. Lower is
            better.</li>
          <li><strong style="color:var(--text-primary)">MAE</strong>: Average miss in rating points. Lower is better.
          </li>
          <li><strong style="color:var(--text-primary)">R²</strong>: Variance explained. Closer to 1.0 is better.</li>
          <li><strong style="color:var(--text-primary)">Residual</strong>: Actual - Predicted. Positive means the model
            under-rates the player (potential bargain).</li>
        </ul>
      </div>

      <div class="col-span-4 card primary">
        <h3 style="margin-bottom: 1rem;">Auto Insights</h3>
        <ul class="muted small" id="insightList" style="padding-left: 1.2rem; line-height: 1.5;"></ul>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid">
      <div class="col-span-4 card">
        <h3 style="margin-bottom: 1rem;">Position RMSE (Error by Role)</h3>
        <div id="posChart" style="height: 280px;"></div>
      </div>
      <div class="col-span-4 card">
        <h3 style="margin-bottom: 1rem;">Gender Fairness Gap</h3>
        <div id="genderChart" style="height: 280px;"></div>
      </div>
      <div class="col-span-4 card">
        <h3 style="margin-bottom: 1rem;">OVR Distribution</h3>
        <div id="histChart" style="height: 280px;"></div>
      </div>
    </div>

    <!-- Scatter -->
    <div class="grid">
      <div class="col-span-12 card">
        <h3 style="margin-bottom: 0.5rem;">Actual vs Predicted OVR</h3>
        <div class="muted small" style="margin-bottom: 1rem;">Points below diagonal = Overrated by model. Points above =
          Underrated by model.</div>
        <div id="scatterChart" style="height: 400px;"></div>
      </div>
    </div>

    <!-- Tables -->
    <div class="grid">
      <div class="col-span-6 card">
        <h3 style="margin-bottom: 1rem; color: var(--positive);">Top Underrated (Hidden Gems)</h3>
        <div style="overflow-x: auto;">
          <table class="table-premium">
            <thead>
              <tr>
                <th>Player</th>
                <th>Pos</th>
                <th>League</th>
                <th>Residual</th>
              </tr>
            </thead>
            <tbody id="underratedBody"></tbody>
          </table>
        </div>
      </div>
      <div class="col-span-6 card">
        <h3 style="margin-bottom: 1rem; color: var(--negative);">Top Overrated (Overpriced)</h3>
        <div style="overflow-x: auto;">
          <table class="table-premium">
            <thead>
              <tr>
                <th>Player</th>
                <th>Pos</th>
                <th>League</th>
                <th>Residual</th>
              </tr>
            </thead>
            <tbody id="overratedBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const rootStyle = getComputedStyle(document.documentElement);
    const cssVar = (name) => rootStyle.getPropertyValue(name).trim() || name;
    const fmt = (v, digits = 2) => v === undefined || v === null || isNaN(v) ? '—' : Number(v).toFixed(digits);

    async function loadMetrics() {
      const res = await fetch('/api/metrics');
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch (e) { throw new Error(text); }
      if (!res.ok || data.error) throw new Error(data.error || 'Failed to load metrics');
      return data;
    }

    function renderCards(overall, count) {
      document.getElementById('rmse').textContent = fmt(overall.rmse);
      document.getElementById('mae').textContent = fmt(overall.mae);
      document.getElementById('r2').textContent = fmt(overall.r2, 3);
      document.getElementById('count').textContent = count ?? '—';
    }

    function renderPosChart(data) {
      const el = document.getElementById('posChart');
      if (!el) return;
      const chart = echarts.init(el);
      chart.setOption({
        textStyle: { fontFamily: 'Inter' },
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', backgroundColor: 'rgba(20,20,20,0.9)', textStyle: { color: '#fff' } },
        xAxis: { type: 'value', axisLabel: { color: cssVar('--text-secondary') }, splitLine: { lineStyle: { color: cssVar('--panel-border') } } },
        yAxis: { type: 'category', data: data.map(d => d.Position), axisLabel: { color: cssVar('--text-primary') } },
        series: [{
          type: 'bar',
          data: data.map(d => d.rmse),
          itemStyle: { color: cssVar('--accent-cyan'), borderRadius: [0, 4, 4, 0] },
          label: { show: true, position: 'right', color: cssVar('--text-primary'), formatter: ({ value }) => fmt(value) }
        }],
        grid: { left: 50, right: 30, top: 20, bottom: 30 }
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function renderGenderChart(data) {
      const el = document.getElementById('genderChart');
      const chart = echarts.init(el);
      chart.setOption({
        textStyle: { fontFamily: 'Inter' },
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', backgroundColor: 'rgba(20,20,20,0.9)', textStyle: { color: '#fff' } },
        xAxis: { type: 'category', data: data.map(d => d.GENDER || 'N/A'), axisLabel: { color: cssVar('--text-primary') } },
        yAxis: { type: 'value', axisLabel: { color: cssVar('--text-secondary') }, splitLine: { lineStyle: { color: cssVar('--panel-border') } } },
        series: [{ type: 'bar', data: data.map(d => d.rmse), itemStyle: { color: cssVar('--accent-violet'), borderRadius: [4, 4, 0, 0] } }],
        grid: { left: 40, right: 10, top: 20, bottom: 30 }
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function renderHist(hist) {
      const el = document.getElementById('histChart');
      const chart = echarts.init(el);
      const centers = [];
      for (let i = 0; i < hist.counts.length; i++) {
        centers.push((hist.bins[i] + hist.bins[i + 1]) / 2);
      }
      chart.setOption({
        textStyle: { fontFamily: 'Inter' },
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', backgroundColor: 'rgba(20,20,20,0.9)', textStyle: { color: '#fff' } },
        xAxis: { type: 'category', data: centers.map(v => v.toFixed(0)), axisLabel: { color: cssVar('--text-primary') } },
        yAxis: { type: 'value', axisLabel: { color: cssVar('--text-secondary') }, splitLine: { lineStyle: { color: cssVar('--panel-border') } } },
        series: [{ type: 'bar', data: hist.counts, itemStyle: { color: cssVar('--positive'), borderRadius: [4, 4, 0, 0] } }],
        grid: { left: 40, right: 10, top: 20, bottom: 30 }
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function renderScatter(points) {
      const el = document.getElementById('scatterChart');
      const chart = echarts.init(el);
      chart.setOption({
        textStyle: { fontFamily: 'Inter' },
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(20,20,20,0.9)',
          textStyle: { color: '#fff' },
          formatter: p => `<b>${p.data[2]}</b><br/>Pred ${p.data[0].toFixed(2)} | Actual ${p.data[1].toFixed(2)}`
        },
        xAxis: { name: 'Predicted', axisLabel: { color: cssVar('--text-secondary') }, splitLine: { lineStyle: { color: cssVar('--panel-border') } } },
        yAxis: { name: 'Actual', axisLabel: { color: cssVar('--text-secondary') }, splitLine: { lineStyle: { color: cssVar('--panel-border') } } },
        series: [{
          type: 'scatter',
          data: points.map(p => [p.pred, p.actual, p.name]),
          itemStyle: { color: cssVar('--accent-cyan'), opacity: 0.6 },
          symbolSize: 8,
        }],
        grid: { left: 50, right: 40, top: 20, bottom: 40 }
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function renderTable(rows, targetId) {
      const body = document.getElementById(targetId);
      if (!body) return;
      body.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:600; color:var(--text-primary)">${r.Name}</td>
            <td class="muted">${r.Position || ''}</td>
            <td class="muted">${r.League || ''}</td>
            <td style="font-weight:700; color:${r.residual >= 0 ? cssVar('--positive') : cssVar('--negative')}">${fmt(r.residual)}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderAutoInsights(data) {
      const el = document.getElementById('insightList');
      if (!el) return;
      const items = [];
      if (data.by_position?.length) {
        const best = data.by_position.reduce((a, b) => a.rmse <= b.rmse ? a : b);
        const worst = data.by_position.reduce((a, b) => a.rmse >= b.rmse ? a : b);
        items.push(`Best calibration: <span class="pill positive">${best.Position}</span> (RMSE ${fmt(best.rmse)}).`);
        items.push(`Needs attention: <span class="pill negative">${worst.Position}</span> (RMSE ${fmt(worst.rmse)}).`);
      }
      if (data.by_gender?.length > 1) {
        const sorted = [...data.by_gender].sort((a, b) => a.rmse - b.rmse);
        const spread = sorted[sorted.length - 1].rmse - sorted[0].rmse;
        items.push(`Gender RMSE gap: ${fmt(spread)}. ${spread > 1 ? '<span style="color:var(--warning)">High bias risk.</span>' : 'Acceptable range.'}`);
      }
      if (data.scatter?.length) {
        const residuals = data.scatter.map(p => p.actual - p.pred);
        const meanRes = residuals.reduce((a, b) => a + b, 0) / residuals.length;
        items.push(`Global bias: ${fmt(meanRes)}. ${Math.abs(meanRes) > 0.5 ? '<span style="color:var(--warning)">Significant systematic error.</span>' : 'Well centered.'}`);
      }
      if (!items.length) {
        el.innerHTML = '<li>No significant insights found in this sample.</li>';
        return;
      }
      el.innerHTML = items.map(t => `<li style="margin-bottom:8px;">${t}</li>`).join('');
    }

    (async function init() {
      try {
        const data = await loadMetrics();
        renderCards(data.overall, data.scatter?.length);
        renderPosChart(data.by_position || []);
        renderGenderChart(data.by_gender || []);
        renderHist(data.hist || { counts: [], bins: [] });
        renderScatter(data.scatter || []);
        renderTable(data.underrated || [], 'underratedBody');
        renderTable(data.overrated || [], 'overratedBody');
        renderAutoInsights(data);
      } catch (err) {
        document.body.innerHTML = `<div style="padding:40px; text-align:center; color:var(--negative);">${err.message}</div>`;
      }
    })();
  </script>
</body>

</html>