<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FC26 Analytics Command</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    /* Page specific overrides for dashboard layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .col-3 {
      grid-column: span 3;
    }

    .col-4 {
      grid-column: span 4;
    }

    .col-6 {
      grid-column: span 6;
    }

    .col-8 {
      grid-column: span 8;
    }

    .col-12 {
      grid-column: span 12;
    }

    @media (max-width: 1024px) {

      .col-3,
      .col-4,
      .col-6,
      .col-8 {
        grid-column: span 12 !important;
      }
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .kpi-label {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .chart-container {
      width: 100%;
      height: 300px;
    }

    .section-header {
      grid-column: span 12;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 0.5rem;
      margin-bottom: 0.5rem;
      margin-top: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .tag.highlight {
      background: var(--accent-cyan);
      color: #000;
    }
  </style>
</head>

<body>
  <header>
    <h1>
      <span class="text-gradient">FC26</span> Analytics Command
    </h1>
    <a href="/" class="btn secondary" style="text-decoration: none; font-size: 0.875rem;">‚Üê Back to Engine</a>
  </header>

  <main>
    <!-- KPI Row -->
    <div class="dashboard-grid">
      <div class="col-3 card" style="text-align: center;">
        <div class="kpi-value text-gradient" id="rmse">‚Äî</div>
        <div class="kpi-label">RMSE (Test)</div>
      </div>
      <div class="col-3 card" style="text-align: center;">
        <div class="kpi-value" id="mae" style="color: var(--accent-violet);">‚Äî</div>
        <div class="kpi-label">MAE (Test)</div>
      </div>
      <div class="col-3 card" style="text-align: center;">
        <div class="kpi-value" id="r2" style="color: var(--accent-emerald);">‚Äî</div>
        <div class="kpi-label">R¬≤ Score</div>
      </div>
      <div class="col-3 card" style="text-align: center;">
        <div class="kpi-value" id="count" style="color: var(--text-primary);">‚Äî</div>
        <div class="kpi-label">Total Players</div>
      </div>
    </div>

    <!-- Section: Model DNA -->
    <div class="dashboard-grid">
      <div class="section-header">
        <div class="section-title">üß¨ Model DNA</div>
        <div class="tiny muted">Architecture & metadata</div>
      </div>

      <div class="col-12 card" id="modelDnaCard"
        style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div>
          <div class="tiny muted" style="margin-bottom:4px;">Architecture</div>
          <div style="font-size: 1.5rem; font-weight: 700;" id="modelArch">‚Äî</div>
        </div>
        <div>
          <div class="tiny muted" style="margin-bottom:4px;">Optimization</div>
          <div id="modelOpt" class="muted small">‚Äî</div>
        </div>
        <div>
          <div class="tiny muted" style="margin-bottom:4px;">Training Seed</div>
          <div class="tag" id="modelSeed">‚Äî</div>
        </div>
        <div style="text-align: right;">
          <div class="tiny muted" style="margin-bottom:4px;">Status</div>
          <div class="tag highlight">PRODUCTION READY</div>
        </div>
      </div>
    </div>

    <!-- Section: Intelligence -->
    <div class="dashboard-grid">
      <div class="section-header">
        <div class="section-title">üß† Feature Intelligence</div>
        <div class="tiny muted">What drives the ratings?</div>
      </div>

      <div class="col-6 card">
        <h3>Feature Importance</h3>
        <div class="muted small" style="margin-bottom: 1rem;">Top predictive features (Permutation Importance).</div>
        <div id="featChart" class="chart-container"></div>
      </div>

      <div class="col-6 card">
        <h3>Global Causal Effects</h3>
        <div class="muted small" style="margin-bottom: 1rem;">Average impact of +1 stat increase on OVR across all
          players.</div>
        <div id="causalChart" class="chart-container"></div>
      </div>
    </div>

    <!-- Section: Performance -->
    <div class="dashboard-grid">
      <div class="section-header">
        <div class="section-title">üéØ Model Diagnostics</div>
        <div class="tiny muted">Reliability & Errors</div>
      </div>

      <div class="col-6 card">
        <h3>Actual vs Predicted</h3>
        <div class="muted small" style="margin-bottom: 1rem;">Diagonal = Perfect prediction.</div>
        <div id="scatterChart" class="chart-container"></div>
      </div>

      <div class="col-6 card">
        <h3>Residual Distribution</h3>
        <div class="muted small" style="margin-bottom: 1rem;">Error spread (Actual - Predicted). Centered at 0 is ideal.
        </div>
        <div id="histChart" class="chart-container"></div>
      </div>
    </div>

    <!-- Section: Fairness -->
    <div class="dashboard-grid">
      <div class="section-header">
        <div class="section-title">‚öñÔ∏è Fairness & Bias</div>
        <div class="tiny muted">Performance across cohorts</div>
      </div>

      <div class="col-6 card">
        <h3>RMSE by Position</h3>
        <div id="posChart" style="height: 250px;"></div>
      </div>
      <div class="col-6 card">
        <h3>RMSE by Gender</h3>
        <div id="genderChart" style="height: 250px;"></div>
      </div>
    </div>

    <!-- Tables -->
    <div class="dashboard-grid">
      <div class="col-6 card">
        <h3 style="color: var(--positive);">üíé Hidden Gems (Underrated)</h3>
        <div class="muted small" style="margin-bottom:1rem;">Players performing better than their rating implies.</div>
        <div style="overflow-x: auto;">
          <table class="table-premium">
            <thead>
              <tr>
                <th>Player</th>
                <th>Pos</th>
                <th>Res</th>
              </tr>
            </thead>
            <tbody id="underratedBody"></tbody>
          </table>
        </div>
      </div>
      <div class="col-6 card">
        <h3 style="color: var(--negative);">üìâ Overrated</h3>
        <div class="muted small" style="margin-bottom:1rem;">Players rated higher than their stats suggest.</div>
        <div style="overflow-x: auto;">
          <table class="table-premium">
            <thead>
              <tr>
                <th>Player</th>
                <th>Pos</th>
                <th>Res</th>
              </tr>
            </thead>
            <tbody id="overratedBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <script>
    const rootStyle = getComputedStyle(document.documentElement);
    const cssVar = (name) => rootStyle.getPropertyValue(name).trim() || name;
    const fmt = (v, digits = 2) => v === undefined || v === null || isNaN(v) ? '‚Äî' : Number(v).toFixed(digits);

    // --- API Calls ---
    async function fetchAPI(endpoint) {
      try {
        const res = await fetch(endpoint);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error(`Failed to fetch ${endpoint}`, e);
        return null;
      }
    }

    async function init() {
      // Parallel Fetch
      const [metrics, modelMeta, importances, causal] = await Promise.all([
        fetchAPI('/api/metrics'),
        fetchAPI('/api/model_meta'),
        fetchAPI('/api/feature_importance?limit=15'),
        fetchAPI('/api/causal')
      ]);

      if (metrics) {
        renderKPIs(metrics);
        renderScatter(metrics.scatter);
        renderResidualHist(metrics.scatter);
        renderFairness(metrics.by_position, metrics.by_gender);
        renderTables(metrics.underrated, metrics.overrated);
      }

      if (modelMeta) renderModelMeta(modelMeta);
      if (importances) renderImportances(importances.features);
      if (causal) renderCausal(causal.effects);
    }

    // --- Renderers ---

    function renderKPIs(data) {
      document.getElementById('rmse').textContent = fmt(data.overall.rmse);
      document.getElementById('mae').textContent = fmt(data.overall.mae);
      document.getElementById('r2').textContent = fmt(data.overall.r2, 3);

      // Count total from scatter or passed count
      // The API returns 'hist' with counts, we can sum them
      const count = data.hist?.counts?.reduce((a, b) => a + b, 0) || 0;
      document.getElementById('count').textContent = count.toLocaleString();
    }

    function renderModelMeta(data) {
      document.getElementById('modelArch').textContent = data.best_model || 'Unknown';
      document.getElementById('modelOpt').textContent = `${data.trials} trials driven by Optuna`;
      document.getElementById('modelSeed').textContent = `Seed: ${data.random_state}`;
    }

    function renderImportances(features) {
      const el = document.getElementById('featChart');
      const chart = echarts.init(el);
      if (!features || !features.length) return;

      // Sort descending
      features.sort((a, b) => a.importance_mean - b.importance_mean);

      const names = features.map(f => f.feature.replace(/^(num__|cat__)/, ''));
      const values = features.map(f => f.importance_mean);

      chart.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '4%', bottom: '3%', top: '3%', containLabel: true },
        xAxis: { type: 'value', splitLine: { show: false } },
        yAxis: { type: 'category', data: names, axisLabel: { color: cssVar('--text-secondary') }, axisLine: { show: false }, axisTick: { show: false } },
        series: [
          {
            type: 'bar',
            data: values,
            itemStyle: { color: cssVar('--accent-cyan'), borderRadius: [0, 4, 4, 0] },
            barWidth: '60%'
          }
        ]
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function renderCausal(effects) {
      const el = document.getElementById('causalChart');
      const chart = echarts.init(el);
      if (!effects || !effects.length) return;

      // Show top 10 positive effects
      const sorted = effects.sort((a, b) => b.per_unit_effect - a.per_unit_effect).slice(0, 10).reverse(); // reverse for horizontal bar
      const names = sorted.map(e => e.feature);
      const values = sorted.map(e => e.per_unit_effect);

      chart.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', formatter: '{b}: +{c} OVR per unit' },
        grid: { left: '3%', right: '4%', bottom: '3%', top: '3%', containLabel: true },
        xAxis: { type: 'value', splitLine: { show: false } },
        yAxis: { type: 'category', data: names, axisLabel: { color: cssVar('--text-secondary') }, axisLine: { show: false }, axisTick: { show: false } },
        series: [
          {
            type: 'bar',
            data: values,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: cssVar('--accent-violet') },
                { offset: 1, color: cssVar('--accent-pink') }
              ]),
              borderRadius: [0, 4, 4, 0]
            },
            barWidth: '60%'
          }
        ]
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function renderScatter(points) {
      const el = document.getElementById('scatterChart');
      const chart = echarts.init(el);
      const data = points.map(p => [p.pred, p.actual, p.name]); // [x, y, name]

      chart.setOption({
        backgroundColor: 'transparent',
        tooltip: {
          formatter: (p) => `<b>${p.data[2]}</b><br>Pred: ${p.data[0].toFixed(1)}<br>Act: ${p.data[1]}`
        },
        grid: { left: '8%', right: '8%', bottom: '12%', top: '12%' },
        xAxis: { name: 'Predicted', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        yAxis: { name: 'Actual', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [{
          type: 'scatter',
          symbolSize: 6,
          itemStyle: { color: 'rgba(34, 211, 238, 0.6)' },
          data: data
        },
        {
          type: 'line',
          data: [[min(data), min(data)], [max(data), max(data)]],
          showSymbol: false,
          lineStyle: { type: 'dashed', color: '#666' }
        }]
      });
      window.addEventListener('resize', () => chart.resize());
    }

    function min(data) { return Math.min(...data.map(d => Math.min(d[0], d[1]))); }
    function max(data) { return Math.max(...data.map(d => Math.max(d[0], d[1]))); }

    function renderResidualHist(points) {
      const el = document.getElementById('histChart');
      const chart = echarts.init(el);
      const residuals = points.map(p => p.actual - p.pred);

      // Simple binning
      const bins = echarts.jupyter ? null : histogram(residuals, 20);

      chart.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        grid: { left: '8%', right: '8%', bottom: '12%', top: '12%' },
        xAxis: { type: 'category', data: bins.labels, axisLabel: { color: '#888' } },
        yAxis: { type: 'value', splitLine: { show: false } },
        series: [{
          type: 'bar',
          data: bins.counts,
          itemStyle: { color: cssVar('--accent-emerald') },
          barWidth: '95%'
        }]
      });
      window.addEventListener('resize', () => chart.resize());
    }

    // Helper histogram function since we don't have numpy
    function histogram(data, binCount) {
      const min = Math.min(...data);
      const max = Math.max(...data);
      const step = (max - min) / binCount;
      const counts = new Array(binCount).fill(0);
      const labels = [];

      for (let i = 0; i < binCount; i++) {
        labels.push((min + i * step).toFixed(1));
      }

      data.forEach(v => {
        const idx = Math.min(Math.floor((v - min) / step), binCount - 1);
        counts[idx]++;
      });
      return { counts, labels };
    }

    function renderFairness(posData, genderData) {
      // Postion Chart
      const posEl = document.getElementById('posChart');
      if (posData && posEl) {
        const chart = echarts.init(posEl);
        const sorted = posData.sort((a, b) => a.rmse - b.rmse);
        chart.setOption({
          backgroundColor: 'transparent',
          tooltip: { trigger: 'axis' },
          grid: { bottom: 20, top: 10, left: 10, right: 20, containLabel: true },
          xAxis: { type: 'value', splitLine: { show: false } },
          yAxis: { type: 'category', data: sorted.map(d => d.Position), axisLine: { show: false }, axisTick: { show: false }, axisLabel: { color: '#888' } },
          series: [{ type: 'bar', data: sorted.map(d => d.rmse), itemStyle: { color: '#64748b' } }]
        });
        window.addEventListener('resize', () => chart.resize());
      }

      // Gender Chart
      const genEl = document.getElementById('genderChart');
      if (genderData && genEl) {
        const chart = echarts.init(genEl);
        chart.setOption({
          backgroundColor: 'transparent',
          tooltip: { trigger: 'axis' },
          grid: { bottom: 20, top: 10, left: 10, right: 20, containLabel: true },
          xAxis: { type: 'value', splitLine: { show: false } },
          yAxis: { type: 'category', data: genderData.map(d => d.GENDER || 'N/A'), axisLine: { show: false }, axisTick: { show: false }, axisLabel: { color: '#888' } },
          series: [{ type: 'bar', data: genderData.map(d => d.rmse), itemStyle: { color: '#8b5cf6' }, barWidth: 30 }]
        });
        window.addEventListener('resize', () => chart.resize());
      }
    }

    function renderTables(underrated, overrated) {
      const fill = (id, data) => {
        const el = document.getElementById(id);
        el.innerHTML = data.slice(0, 5).map(r => `
                <tr>
                    <td style="font-weight:600;">${r.Name}</td>
                    <td class="muted small">${r.Position}</td>
                    <td style="font-weight:700; color:${r.residual > 0 ? 'var(--positive)' : 'var(--negative)'}">${r.residual > 0 ? '+' : ''}${r.residual.toFixed(2)}</td>
                </tr>
            `).join('');
      };
      if (underrated) fill('underratedBody', underrated);
      if (overrated) fill('overratedBody', overrated);
    }

    // Start
    init();

  </script>
</body>

</html>